name: $(Date:yyyyMMdd)-$(Rev:rrr)

trigger:
- master

resources:
- repo: self

# If you want to push an image is not master yet, you can set the 'PushBeta' variable
# when running the pipeline from a dev branch.
variables:
  DockerRepository: poveilleux5/azure-file-share-explorer
  Version: 0.0.4
  IsMaster: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/master') }}

stages:
- stage: Build
  displayName: Build image
  jobs:  
  - job: Build
    pool:
      vmImage: ubuntu-16.04
    steps:
    - script: |
        echo "IsMaster: $IsMaster"
        echo "Version: $Version"
        ImageTag="$Version-beta"
        if [[ $IsMaster = "False" ]]; then
          ImageTag="$Version-build-$BuildNumber"
        fi
        echo "##vso[task.setvariable variable=ImageTag]$ImageTag"
        echo "ImageTag: $ImageTag"
      displayName: Compute image tag
      env:
        BuildNumber: $(Build.BuildNumber)
        IsMaster: $(IsMaster)
        Version: $(Version)

    - task: Docker@2
      displayName: Build $(DockerRepository)
      inputs:
        command: build
        containerRegistry: DockerHub
        repository: $(DockerRepository)
        dockerfile: $(Build.SourcesDirectory)/Dockerfile
        tags: $(ImageTag)

    - task: Docker@2
      condition: and(succeeded(), or(eq(variables['IsMaster'], true), eq(variables['PushBeta'], true)))
      displayName: Push $(DockerRepository)
      inputs:
        command: push
        containerRegistry: DockerHub
        repository: $(DockerRepository)
        tags: $(ImageTag)
    
    - script: |
        helm init --client-only
        helm package azure-file-share-explorer --destination $(Build.ArtifactStagingDirectory) --app-version $(ImageTag)
      displayName: Package helm chart
      workingDirectory: chart/

    - task: PublishBuildArtifacts@1
      displayName: Publish artifacts
      inputs:
        pathtoPublish: $(Build.ArtifactStagingDirectory)
        artifactName: drop
